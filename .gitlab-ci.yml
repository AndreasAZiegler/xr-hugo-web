image:
  name: klakegg/hugo:ext-alpine-ci 
  entrypoint: ["/bin/sh", "-c"]
  
master-build:
  stage: build
  script:
    - hugo
  artifacts:
    paths:
    - public
  only:
  - master
  interruptible: true

master-deploy:
  stage: deploy
  before_script:
    # Install expect
    - apk add expect

    # Install ssh client
    - apk add openssh-client

    # Install rsync
    - apk add rsync

    # Set up keys
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    # Load key with passphrase
    - eval $(ssh-agent -s)
    - expect -c 'spawn ssh-add /tmp/.ssh/id_rsa; expect "Enter passphrase for /tmp/.ssh/id_rsa:"; send "$env(KEY_PASSPHRASE)\r"; expect eof'

    # Set up known hosts
    - echo "$KNOWN_HOST" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

  script:
    # Backup old version
    - ssh -o StrictHostKeyChecking=no hvoajxlo@185.165.170.81 '/home/hvoajxlo/bin/backup_hugo'
    
    # Transfer files
    - rsync -aq -delete -e ssh -z -r public/ hvoajxlo@185.165.170.81:/home/hvoajxlo/upload/

    # Move new files into place
    - ssh hvoajxlo@185.165.170.81 '/home/hvoajxlo/bin/sync_hugo'

  only:
    - master
